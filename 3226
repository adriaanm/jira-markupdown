(In r21420) Interrupted attempt to fix SI-2897. I am committing what I have because the refactorings improve things a little bit. To fix the ticket a frightening lot more has to be done.
