This has the same underlying problems as scala/bug#967.
