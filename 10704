Minimal test:

{code}
package scala.tools.selectivecps

import scala.annotation._
import scala.util.continuations._
  
class While {
  def foo1(): Int @cps[Unit] = 2
  def foo2(): Int @cps[Unit] = shift { k => k(2) }

  def test2(): Unit @cps[Unit] = {
    var x = 0
    while (x < 9000) { // pick number large enough to require tail-call opt
      x = x + (if (x % 1000 != 0) foo1() else foo2())
    }
    ()
  }

  def while2 = {
    reset(test2())
  }
}
{code}
