Stefan's problem with Vaadin appears to stem from a deficient {{InnerClasses}} section in org.vaadin.sasha.portallayout.PortalLayout

{noformat}
% qbin/scala -Ydebug -classpath /Users/jason/Downloads/tiny-vaadin/vaadin-6.8.8.jar:/Users/jason/Downloads/tiny-vaadin/portallayout-1.3.1.jar:.

% curl --silent https://vaadin-portal-layout.googlecode.com/svn-history/r10/trunk/src/org/vaadin/sasha/portallayout/PortalLayout.java | head -25
{noformat}
{code}
package org.vaadin.sasha.portallayout;

import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import org.vaadin.sasha.portallayout.client.ui.VPortalLayout;

import com.vaadin.terminal.PaintException;
import com.vaadin.terminal.PaintTarget;
import com.vaadin.ui.AbstractLayout;
import com.vaadin.ui.ClientWidget;
import com.vaadin.ui.Component;
import com.vaadin.ui.ClientWidget.LoadStyle;

/**
 * Layout that presents its contents in a portal style.
 * @author p4elkin
 */
@SuppressWarnings("serial")
@ClientWidget(value = VPortalLayout.class, loadStyle = LoadStyle.EAGER)
public class PortalLayout extends AbstractLayout {
{code}

{noformat}
scala> :javap org.vaadin.sasha.portallayout.PortalLayout
Compiled from "PortalLayout.java"
public class org.vaadin.sasha.portallayout.PortalLayout extends com.vaadin.ui.AbstractLayout implements com.vaadin.ui.Layout$SpacingHandler,com.vaadin.event.LayoutEvents$LayoutClickNotifier
  SourceFile: "PortalLayout.java"
  RuntimeVisibleAnnotations: length = 0x12
   00 01 02 54 00 02 02 55 63 02 56 02 57 65 02 58
   02 59
  InnerClass:
   public #605= #132 of #603; //LayoutClickEvent=class com/vaadin/event/LayoutEvents$LayoutClickEvent of class com/vaadin/event/LayoutEvents
   public abstract #606= #135 of #603; //LayoutClickListener=class com/vaadin/event/LayoutEvents$LayoutClickListener of class com/vaadin/event/LayoutEvents
   public abstract #607= #7 of #603; //LayoutClickNotifier=class com/vaadin/event/LayoutEvents$LayoutClickNotifier of class com/vaadin/event/LayoutEvents
   public #610= #608 of #176; //Event=class com/vaadin/ui/Component$Event of class com/vaadin/ui/Component
   public abstract #613= #5 of #611; //SpacingHandler=class com/vaadin/ui/Layout$SpacingHandler of class com/vaadin/ui/Layout
   public abstract #614= #468 of #63; //Entry=class java/util/Map$Entry of class java/util/Map
   public abstract #617= #615 of #1; //PortletCloseListener=class org/vaadin/sasha/portallayout/PortalLayout$PortletCloseListener of class org/vaadin/sasha/portallayout/PortalLayout
   public #618= #91 of #1; //PortletClosedEvent=class org/vaadin/sasha/portallayout/PortalLayout$PortletClosedEvent of class org/vaadin/sasha/portallayout/PortalLayout
   public #619= #106 of #1; //PortletCollapseEvent=class org/vaadin/sasha/portallayout/PortalLayout$PortletCollapseEvent of class org/vaadin/sasha/portallayout/PortalLayout
   public abstract #622= #620 of #1; //PortletCollapseListener=class org/vaadin/sasha/portallayout/PortalLayout$PortletCollapseListener of class org/vaadin/sasha/portallayout/PortalLayout
  minor version: 0
  major version: 50
  Constant pool:
...
const #596 = Asciz	Lcom/vaadin/ui/ClientWidget;;
const #597 = Asciz	value;
const #598 = Asciz	Lorg/vaadin/sasha/portallayout/client/ui/VPortalLayout;;
const #599 = Asciz	loadStyle;
const #600 = Asciz	Lcom/vaadin/ui/ClientWidget$LoadStyle;;
const #601 = Asciz	EAGER;
const #602 = Asciz	InnerClasses;
const #603 = class	#604;	//  com/vaadin/event/LayoutEvents
...
{noformat}

I tried to compile a stripped down version of that class:

{code}
package test;

import com.vaadin.ui.AbstractLayout;
import com.vaadin.ui.ClientWidget;
import com.vaadin.ui.ClientWidget.LoadStyle;

@ClientWidget(value = com.vaadin.terminal.gwt.client.Paintable.class, loadStyle = LoadStyle.EAGER)
public abstract class PortalLayout extends AbstractLayout {
}
{code}

{noformat}
% javac -version javac 1.6.0_37

% qbin/scala -Ydebug -classpath /Users/jason/Downloads/tiny-vaadin/vaadin-6.8.8.jar:/Users/jason/Downloads/tiny-vaadin/portallayout-1.3.1.jar:.

scala> :javap test/PortalLayout
Compiled from "PortalLayout.java"
public abstract class test.PortalLayout extends com.vaadin.ui.AbstractLayout
  SourceFile: "PortalLayout.java"
  RuntimeVisibleAnnotations: length = 0x12
   00 01 00 0B 00 02 00 0C 63 00 0D 00 0E 65 00 12
   00 13
  InnerClass:
   public final #16= #15 of #23; //LoadStyle=class com/vaadin/ui/ClientWidget$LoadStyle of class com/vaadin/ui/ClientWidget
  minor version: 0
  major version: 50
  Constant pool:
const #1 = Method	#3.#20;	//  com/vaadin/ui/AbstractLayout."<init>":()V
const #2 = class	#21;	//  test/PortalLayout
const #3 = class	#22;	//  com/vaadin/ui/AbstractLayout
const #4 = Asciz	<init>;
const #5 = Asciz	()V;
const #6 = Asciz	Code;
const #7 = Asciz	LineNumberTable;
const #8 = Asciz	SourceFile;
const #9 = Asciz	PortalLayout.java;
const #10 = Asciz	RuntimeVisibleAnnotations;
const #11 = Asciz	Lcom/vaadin/ui/ClientWidget;;
const #12 = Asciz	value;
const #13 = Asciz	Lcom/vaadin/terminal/gwt/client/Paintable;;
const #14 = Asciz	loadStyle;
const #15 = class	#24;	//  com/vaadin/ui/ClientWidget$LoadStyle
const #16 = Asciz	LoadStyle;
const #17 = Asciz	InnerClasses;
const #18 = Asciz	Lcom/vaadin/ui/ClientWidget$LoadStyle;;
const #19 = Asciz	EAGER;
const #20 = NameAndType	#4:#5;//  "<init>":()V
const #21 = Asciz	test/PortalLayout;
const #22 = Asciz	com/vaadin/ui/AbstractLayout;
const #23 = class	#25;	//  com/vaadin/ui/ClientWidget
const #24 = Asciz	com/vaadin/ui/ClientWidget$LoadStyle;
const #25 = Asciz	com/vaadin/ui/ClientWidget;
{noformat}

The JAR file containing the class in question contains:

META-INF:

{noformat}
Manifest-Version: 1.0
Implementation-Title: PortalLayout
Implementation-Version: 1.3.1
Vaadin-Package-Version: 1
Class-Path: 
Vaadin-Widgetsets: org.vaadin.sasha.portallayout.PortallayoutWidgetset
{noformat}

rebel.xml

{noformat}
<?xml version="1.0" encoding="UTF-8"?>
<application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.zeroturnaround.com" xsi:schemaLocation="http://www.zeroturnaround.com http://www.zeroturnaround.com/alderaan/rebel-2_0.xsd">

	<classpath>
		<dir name="/Users/p4elkin/Projects/PortalLayout/build/classes">
		</dir>
	</classpath>

	<web>
		<link target="/">
			<dir name="/Users/p4elkin/Projects/PortalLayout/WebContent">
			</dir>
		</link>
	</web>

</application>

{noformat}

The repository doesn't have an Ant/Maven build or the like. Not sure what Java compiler generated that bytecode, nor which tools had their way with it. (This is all GWT related, maybe that gets involved.)

The JVM spec offers:

{quote}
The InnerClasses attribute is a variable-length attribute in the attributes table of a ClassFile structure (ยง4.1). If the constant pool of a class or interface C contains a CONSTANT_Class_info entry which represents a class or interface that is not a member of a package, then C's ClassFile structure must have exactly one InnerClasses attribute in its attributes table.
...
If a class has members that are classes or interfaces, its constant_pool table (and hence its InnerClasses attribute) must refer to each such member, even if that member is not otherwise mentioned by the class. These rules imply that a nested class or interface member will have 
InnerClasses information for each enclosing class and for each immediate member.
{quote}

Long story short, I'll submit Paul's patch to make us resilient against such bytecode.
