(In r24224) Closes scala/bug#3986 plus some cleanup. no review
