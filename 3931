(In r21722) Closes SI-3365. Adds test for new code. Review by prokopec.
