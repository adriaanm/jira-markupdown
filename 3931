(In r21722) Closes scala/bug#3365. Adds test for new code. Review by prokopec.
