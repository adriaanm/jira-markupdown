Extracted from scala/bug#6825
