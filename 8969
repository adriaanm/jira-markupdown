I don't know the details so I still don't know what's tricky here. In Scala, you can put class definition anywhere so you don't need to mutate tree globally but just locally. So:
```scala
class Foo extends macroDef("A")
```

could be expanded to
```scala
class macroDefExpanded_A { .. }
class Foo extends macroDefExpanded_A { .. }
```

and this is fairly local.

The problem is those virtual compilation units is that it's not clear how to track dependencies on them, also IDE will have a very hard time to work with them when it does indexing or resolves target of "Jump to definition".
