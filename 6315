I think this is fixed, possibly not for all cases, in r25326.  I don't have time right now to do a lot more investigating, so if anyone wants to give me an update on what's still broken it would help.
