Very similar to scala/bug#1980.
