It's very similar to scala/bug#5579
