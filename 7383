It's very similar to https://issues.scala-lang.org/browse/SI-5579
