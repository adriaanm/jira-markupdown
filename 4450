(In r23555) Fixes SI-3647, closes SI-3647, adds a test case for it, and a missing test case for SI-3935.

No review.
