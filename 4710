Curiously enough, once I had a proper test suite in place, doing the actual work was pretty quick. I reused most of the stuff from the previous broken patch, with just a few minor modifications.

Patch is here: http://github.com/dcsobral/scala/commit/e87ed79e78378b864eacbc498554f224de177ccc

However, even though it passed all tests from my test suite (and it *didn't* pass some when I had something wrong -- which gives me some confidence on the test suite itself :), it is rather big and a bit complex. Commit with care.
