The patch seems to only cover the second part of the solution, without the setlocal statement. This is a common problem, getting more common as 64 bits windows become more widely used. Also, it is widely misdiagnosed. Thumbs up for this patch!
