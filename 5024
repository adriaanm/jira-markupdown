(In r23534) Fixes scala/bug#3989, adding test cases for scala/bug#3989 and scala/bug#3996.

No review.
