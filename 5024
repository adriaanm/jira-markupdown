(In r23534) Fixes SI-3989, adding test cases for SI-3989 and SI-3996.

No review.
