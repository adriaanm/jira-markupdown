(In r23536) Fixes scala/bug#3970 and a bunch of other issues.

Review by extempore.
