(In r23536) Fixes SI-3970 and a bunch of other issues.

Review by extempore.
